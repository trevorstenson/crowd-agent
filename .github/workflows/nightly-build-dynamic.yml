name: Nightly Build (Dynamic Rounds)

on:
  workflow_dispatch:
    inputs:
      model:
        description: 'Ollama model for all LLM calls'
        required: false
        default: 'qwen3:8b'
      round_state_branch:
        description: 'Branch with existing round state (empty = fresh run)'
        required: false
        default: ''

concurrency:
  group: dynamic-agent-build
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  # ──────────────────────────────────────────────
  # Job 1: Router (no Ollama needed)
  # Find issue / load state, set phase outputs
  # ──────────────────────────────────────────────
  router:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      phase: ${{ steps.route.outputs.phase }}
      has_llm: ${{ steps.route.outputs.has_llm }}
      has_explore: ${{ steps.route.outputs.has_explore }}
      explore_matrix: ${{ steps.route.outputs.explore_matrix }}
      round_number: ${{ steps.route.outputs.round_number }}
      issue_number: ${{ steps.route.outputs.issue_number }}
      state_branch: ${{ steps.route.outputs.state_branch }}
    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          ref: local-agent-dynamic
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run router
        id: route
        env:
          LLM_PROVIDER: ollama
          OLLAMA_MODEL: ${{ inputs.model || 'qwen3:8b' }}
          GH_PAT: ${{ steps.app-token.outputs.token }}
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          BOT_LOGIN: crowd-agent-bot[bot]
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          TWITTER_DRY_RUN: 'true'
          ROUND_STATE_BRANCH: ${{ inputs.round_state_branch }}
        run: python agent/round_main.py --phase route

  # ──────────────────────────────────────────────
  # Job 2: LLM Work (needs Ollama)
  # Plan or edit based on router phase output
  # ──────────────────────────────────────────────
  llm_work:
    needs: router
    if: needs.router.outputs.has_llm == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 35
    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.router.outputs.state_branch }}
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Cache Ollama models
        id: cache-ollama
        uses: actions/cache@v4
        with:
          path: ~/.ollama/models
          key: ollama-dynamic-${{ inputs.model || 'qwen3:8b' }}-v1

      - name: Install Ollama
        run: curl -fsSL https://ollama.com/install.sh | sh

      - name: Start Ollama server
        env:
          OLLAMA_FLASH_ATTENTION: '1'
          OLLAMA_KV_CACHE_TYPE: q8_0
          OLLAMA_KEEP_ALIVE: '-1'
        run: |
          ollama serve &
          for i in $(seq 1 30); do
            if curl -sf http://localhost:11434/api/tags > /dev/null 2>&1; then
              echo "Ollama is ready"
              break
            fi
            echo "Waiting for Ollama... ($i/30)"
            sleep 2
          done

      - name: Pull model
        if: steps.cache-ollama.outputs.cache-hit != 'true'
        run: ollama pull ${{ inputs.model || 'qwen3:8b' }}

      - name: Warm model
        run: |
          curl -sf http://localhost:11434/v1/chat/completions \
            -H "Content-Type: application/json" \
            -d '{"model": "${{ inputs.model || 'qwen3:8b' }}", "messages": [{"role": "user", "content": "Say hello in one word."}], "max_tokens": 10}' \
            | python -c "import sys, json; r = json.load(sys.stdin); print('Warm-up:', r['choices'][0]['message']['content'])"

      - name: Run LLM work
        env:
          LLM_PROVIDER: ollama
          OLLAMA_MODEL: ${{ inputs.model || 'qwen3:8b' }}
          GH_PAT: ${{ steps.app-token.outputs.token }}
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          BOT_LOGIN: crowd-agent-bot[bot]
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          ROUND_PHASE: ${{ needs.router.outputs.phase }}
          ROUND_NUMBER: ${{ needs.router.outputs.round_number }}
        run: python agent/round_main.py --phase llm_work

  # ──────────────────────────────────────────────
  # Job 3: Dispatch (no Ollama needed)
  # Commit state, trigger next round or finalize
  # ──────────────────────────────────────────────
  dispatch:
    needs: [router, llm_work]
    if: always() && needs.router.result == 'success' && needs.router.outputs.phase != 'none' && needs.router.outputs.state_branch != ''
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.router.outputs.state_branch }}
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Pull latest from agent branch
        run: |
          git fetch origin
          git pull origin ${{ needs.router.outputs.state_branch }} --ff-only || true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run dispatch
        env:
          LLM_PROVIDER: ollama
          OLLAMA_MODEL: ${{ inputs.model || 'qwen3:8b' }}
          GH_PAT: ${{ steps.app-token.outputs.token }}
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          BOT_LOGIN: crowd-agent-bot[bot]
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          ISSUE_NUMBER: ${{ needs.router.outputs.issue_number }}
          WORKFLOW_REF: local-agent-dynamic
          TWITTER_DRY_RUN: 'true'
        run: python agent/round_main.py --phase dispatch
