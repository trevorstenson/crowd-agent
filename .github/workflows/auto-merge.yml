name: Auto-Merge Agent PRs

on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [closed]
  schedule:
    - cron: '0 */6 * * *'  # Check every 6 hours for stale PRs

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  auto-merge:
    if: github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    steps:
      - name: Check approvals and merge
        id: merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          # Get reviews
          APPROVALS=$(gh api repos/$REPO/pulls/$PR_NUMBER/reviews \
            --jq '[.[] | select(.state == "APPROVED")] | length')
          CHANGES_REQUESTED=$(gh api repos/$REPO/pulls/$PR_NUMBER/reviews \
            --jq '[.[] | select(.state == "CHANGES_REQUESTED")] | length')

          echo "Approvals: $APPROVALS, Changes requested: $CHANGES_REQUESTED"

          if [ "$APPROVALS" -ge 1 ] && [ "$CHANGES_REQUESTED" -eq 0 ]; then
            echo "Merging PR #$PR_NUMBER"
            gh pr merge $PR_NUMBER --repo $REPO --squash --delete-branch
            echo "merged=true" >> $GITHUB_OUTPUT

            # Find linked issue and label it shipped
            ISSUE_NUMBER=$(gh pr view $PR_NUMBER --repo $REPO --json body \
              --jq '.body' | grep -oP 'Closes #\K\d+' | head -1)

            if [ -n "$ISSUE_NUMBER" ]; then
              echo "Labeling issue #$ISSUE_NUMBER as shipped"
              gh issue edit $ISSUE_NUMBER --repo $REPO --add-label "shipped" --remove-label "review,building"
              gh issue close $ISSUE_NUMBER --repo $REPO
            fi
          else
            echo "Not enough approvals or changes requested. Skipping."
            echo "merged=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repo
        if: steps.merge.outputs.merged == 'true'
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Update changelog and memory
        if: steps.merge.outputs.merged == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          # Extract changelog from PR body between markers
          PR_BODY=$(gh pr view $PR_NUMBER --repo $REPO --json body --jq '.body')
          CHANGELOG_ENTRY=$(echo "$PR_BODY" | sed -n '/<!-- CHANGELOG_START -->/,/<!-- CHANGELOG_END -->/{ /<!-- CHANGELOG_START -->/d; /<!-- CHANGELOG_END -->/d; p; }')

          # Find the issue number from the PR body
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -oP 'Closes #\K\d+' | head -1)

          if [ -n "$CHANGELOG_ENTRY" ]; then
            # Skip if this issue's entry already exists (PR may have edited CHANGELOG.md directly)
            if [ -n "$ISSUE_NUMBER" ] && [ -f CHANGELOG.md ] && grep -q "## \[.\] #$ISSUE_NUMBER " CHANGELOG.md; then
              echo "Changelog entry for issue #$ISSUE_NUMBER already exists. Skipping insertion."
            elif [ -f CHANGELOG.md ] && grep -q '^---$' CHANGELOG.md; then
              echo "Found changelog entry, appending to CHANGELOG.md"
              SEPARATOR_LINE=$(grep -n '^---$' CHANGELOG.md | head -1 | cut -d: -f1)
              {
                head -n "$SEPARATOR_LINE" CHANGELOG.md
                echo ""
                echo "$CHANGELOG_ENTRY"
                tail -n +"$((SEPARATOR_LINE + 1))" CHANGELOG.md
              } > CHANGELOG.md.tmp
              mv CHANGELOG.md.tmp CHANGELOG.md
            else
              echo "Found changelog entry, creating CHANGELOG.md"
              {
                echo "# Changelog"
                echo ""
                echo "The agent's autobiography — written after each build."
                echo ""
                echo "---"
                echo ""
                echo "$CHANGELOG_ENTRY"
              } > CHANGELOG.md
            fi
          else
            echo "No changelog entry found in PR body, skipping changelog update"
          fi

          # Update memory.json
          if [ -f agent/memory.json ]; then
            DATE_NOW=$(date -u +"%Y-%m-%dT%H:%M:%S+00:00")
            jq \
              --arg date "$DATE_NOW" \
              '.total_builds += 1 | .successful_builds += 1 | .streak += 1 | .last_build_date = $date' \
              agent/memory.json > agent/memory.json.tmp
            mv agent/memory.json.tmp agent/memory.json
          fi

          # Commit and push
          git config user.name "CrowdPilot[bot]"
          git config user.email "crowdpilot-bot@users.noreply.github.com"
          git add CHANGELOG.md agent/memory.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update changelog and memory after merge of PR #$PR_NUMBER"
          git push

  # Handles direct merges (not via the auto-merge job above)
  post-merge:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Update changelog and memory
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          # Skip if the auto-merge job already committed for this PR
          LAST_COMMIT=$(git log -1 --format=%s)
          if echo "$LAST_COMMIT" | grep -q "after merge of PR #$PR_NUMBER"; then
            echo "Auto-merge job already updated changelog/memory for PR #$PR_NUMBER. Skipping."
            exit 0
          fi

          # Extract changelog from PR body between markers
          PR_BODY=$(gh pr view $PR_NUMBER --repo $REPO --json body --jq '.body')
          CHANGELOG_ENTRY=$(echo "$PR_BODY" | sed -n '/<!-- CHANGELOG_START -->/,/<!-- CHANGELOG_END -->/{ /<!-- CHANGELOG_START -->/d; /<!-- CHANGELOG_END -->/d; p; }')

          # Find the issue number from the PR body
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -oP 'Closes #\K\d+' | head -1)

          if [ -n "$CHANGELOG_ENTRY" ]; then
            # Skip if this issue's entry already exists (PR may have edited CHANGELOG.md directly)
            if [ -n "$ISSUE_NUMBER" ] && [ -f CHANGELOG.md ] && grep -q "## \[.\] #$ISSUE_NUMBER " CHANGELOG.md; then
              echo "Changelog entry for issue #$ISSUE_NUMBER already exists. Skipping insertion."
            elif [ -f CHANGELOG.md ] && grep -q '^---$' CHANGELOG.md; then
              echo "Found changelog entry, appending to CHANGELOG.md"
              SEPARATOR_LINE=$(grep -n '^---$' CHANGELOG.md | head -1 | cut -d: -f1)
              {
                head -n "$SEPARATOR_LINE" CHANGELOG.md
                echo ""
                echo "$CHANGELOG_ENTRY"
                tail -n +"$((SEPARATOR_LINE + 1))" CHANGELOG.md
              } > CHANGELOG.md.tmp
              mv CHANGELOG.md.tmp CHANGELOG.md
            else
              echo "Found changelog entry, creating CHANGELOG.md"
              {
                echo "# Changelog"
                echo ""
                echo "The agent's autobiography — written after each build."
                echo ""
                echo "---"
                echo ""
                echo "$CHANGELOG_ENTRY"
              } > CHANGELOG.md
            fi
          else
            echo "No changelog entry found in PR body, skipping changelog update"
          fi

          # Update memory.json
          if [ -f agent/memory.json ]; then
            DATE_NOW=$(date -u +"%Y-%m-%dT%H:%M:%S+00:00")
            jq \
              --arg date "$DATE_NOW" \
              '.total_builds += 1 | .successful_builds += 1 | .streak += 1 | .last_build_date = $date' \
              agent/memory.json > agent/memory.json.tmp
            mv agent/memory.json.tmp agent/memory.json
          fi

          # Commit and push
          git config user.name "CrowdPilot[bot]"
          git config user.email "crowdpilot-bot@users.noreply.github.com"
          git add CHANGELOG.md agent/memory.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update changelog and memory after merge of PR #$PR_NUMBER"
          git push

  requeue-rejected:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && !github.event.pull_request.merged
    runs-on: ubuntu-latest
    steps:
      - name: Relabel issue back to voting
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          # Find linked issue from PR body
          ISSUE_NUMBER=$(gh pr view $PR_NUMBER --repo $REPO --json body \
            --jq '.body' | grep -oP 'Closes #\K\d+' | head -1)

          if [ -n "$ISSUE_NUMBER" ]; then
            echo "PR #$PR_NUMBER closed without merge. Relabeling issue #$ISSUE_NUMBER back to voting."
            gh issue edit $ISSUE_NUMBER --repo $REPO --add-label "voting" --remove-label "review,building"

            # Reset all reactions on the issue so it starts fresh in the voting pool
            echo "Resetting reactions on issue #$ISSUE_NUMBER"
            gh api "repos/$REPO/issues/$ISSUE_NUMBER/reactions" --paginate \
              --jq '.[].id' | while read REACTION_ID; do
              gh api "repos/$REPO/issues/$ISSUE_NUMBER/reactions/$REACTION_ID" -X DELETE
            done
          fi

  cleanup-stale:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Close stale agent PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO=${{ github.repository }}

          # Find open PRs from the agent older than 48 hours
          gh pr list --repo $REPO --state open --author "@me" --json number,createdAt \
            --jq '.[] | select(
              (now - (.createdAt | fromdateiso8601)) > 172800
            ) | .number' | while read PR_NUMBER; do
            echo "Closing stale PR #$PR_NUMBER"
            gh pr close $PR_NUMBER --repo $REPO --comment "Closing: no approval received within 48 hours."

            # Find linked issue and relabel
            ISSUE_NUMBER=$(gh pr view $PR_NUMBER --repo $REPO --json body \
              --jq '.body' | grep -oP 'Closes #\K\d+' | head -1)

            if [ -n "$ISSUE_NUMBER" ]; then
              gh issue edit $ISSUE_NUMBER --repo $REPO --add-label "rejected" --remove-label "review,building"
            fi
          done
